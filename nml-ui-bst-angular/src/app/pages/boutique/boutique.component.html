<mat-sidenav-container class="sidenav-container">
  <!-- Cart Drawer -->
  <mat-sidenav #cartDrawer mode="over" position="end" [opened]="showCart()" (closed)="showCart.set(false)">
    <div class="cart-content">
      <div class="cart-header">
        <h2>Panier</h2>
        <button mat-icon-button (click)="toggleCart()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <mat-divider></mat-divider>

      @if ((cart$ | async)?.length === 0) {
        <div class="empty-cart">
          <mat-icon>shopping_cart</mat-icon>
          <p>Votre panier est vide</p>
        </div>
      } @else {
        <div class="cart-items">
          @for (item of cart$ | async; track item.equipment.name) {
            <div class="cart-item">
              <div class="item-header">
                <h4>{{ item.equipment.name }}</h4>
                <button mat-icon-button color="warn" (click)="removeFromCart(item.equipment.name)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              <p class="item-price">{{ item.equipment.cost }} ₡ × {{ item.quantity }} = {{ item.equipment.cost * item.quantity }} ₡</p>
              <div class="quantity-controls">
                <button mat-icon-button [disabled]="item.quantity <= 1" (click)="updateQuantity(item.equipment.name, item.quantity - 1)">
                  <mat-icon>remove</mat-icon>
                </button>
                <span class="quantity">{{ item.quantity }}</span>
                <button mat-icon-button (click)="updateQuantity(item.equipment.name, item.quantity + 1)">
                  <mat-icon>add</mat-icon>
                </button>
              </div>
            </div>
          }
        </div>

        <mat-divider></mat-divider>

        <div class="cart-total">
          <div class="total-row">
            <span>Total:</span>
            <span class="total-value">{{ totalPrice$ | async }} ₡</span>
          </div>
          <div class="total-row">
            <span>Argent disponible:</span>
            <span>{{ (player$ | async)?.stats?.money | number:'1.0-0' }} ₡</span>
          </div>
        </div>

        <button mat-raised-button
                [color]="canAfford() ? 'primary' : 'warn'"
                [disabled]="!canAfford()"
                class="checkout-btn"
                (click)="checkout()">
          <mat-icon>attach_money</mat-icon>
          {{ canAfford() ? 'Acheter' : 'Fonds insuffisants' }}
        </button>

        <button mat-stroked-button color="warn" class="clear-btn" (click)="clearCart()">
          Vider le panier
        </button>
      }
    </div>
  </mat-sidenav>

  <mat-sidenav-content>
    @if ((loading$ | async) && (equipments$ | async)?.length === 0) {
      <div class="loading-container">
        <mat-spinner diameter="60"></mat-spinner>
      </div>
    } @else {
      <div class="container fade-in">
        <!-- Header -->
        <div class="page-header">
          <div class="header-left">
            <div class="avatar">
              <mat-icon>shopping_bag</mat-icon>
            </div>
            <div>
              <h1 class="title">Boutique d'Équipements</h1>
              <p class="subtitle">
Équipez vos troupes pour la victoire</p>
            </div>
          </div>

          <div class="header-right">
            <div class="money-display">
              <span class="money-label">Argent disponible:</span>
              <span class="money-value">{{ (player$ | async)?.stats?.money | number:'1.0-0' }} ₡</span>
            </div>
            <button mat-raised-button
                    [color]="showCart() ? 'primary' : 'basic'"
                    [matBadge]="(totalItems$ | async) || 0"
                    matBadgeColor="accent"
                    (click)="toggleCart()">
              <mat-icon>shopping_cart</mat-icon>
              Panier ({{ (cart$ | async)?.length || 0 }})
            </button>
          </div>
        </div>

        @if (error$ | async; as error) {
          <div class="error-alert">
            <mat-icon>error</mat-icon>
            {{ error }}
          </div>
        }

        <!-- Barre de recherche avec filtres déroulants -->
        <div class="search-bar-container">
          <div class="search-wrapper">
            <mat-icon class="search-icon">search</mat-icon>
            <input
              type="text"
              class="search-input"
              [(ngModel)]="searchTerm"
              placeholder="Rechercher un équipement...">

            <div class="search-actions">
              @if (searchTerm()) {
                <button class="action-btn clear-btn" (click)="clearSearch()" title="Effacer la recherche">
                  <mat-icon>close</mat-icon>
                </button>
              }

              <button
                class="action-btn filter-toggle-btn"
                [class.active]="showFilters()"
                (click)="toggleFilters()"
                title="Filtres avancés">
                <mat-icon>tune</mat-icon>
                @if (hasAdvancedFilters()) {
                  <span class="filter-badge">{{ getActiveFiltersCount() }}</span>
                }
              </button>
            </div>
          </div>

          <!-- Panneau de filtres déroulant -->
          <div class="filters-panel" [class.open]="showFilters()">
            <div class="filters-content">
              <div class="filters-chips-container">
                <span class="filter-label">
                  <mat-icon>category</mat-icon>
                  Catégories
                </span>
                <div class="chips-wrapper">
                  <button
                    class="custom-chip"
                    [class.active]="selectedCategory() === 'all'"
                    (click)="selectCategory('all')">
                    Toutes
                  </button>
                  @for (category of categories(); track category) {
                    <button
                      class="custom-chip"
                      [class.active]="selectedCategory() === category"
                      (click)="selectCategory(category)">
                      {{ category }}
                    </button>
                  }
                </div>
              </div>

              <mat-divider></mat-divider>

              <div class="filters-chips-container">
                <span class="filter-label">
                  <mat-icon>military_tech</mat-icon>
                  Types de bonus
                </span>
                <div class="chips-wrapper">
                  <button
                    class="custom-chip bonus-chip all"
                    [class.active]="selectedBonusFilter() === 'all'"
                    (click)="selectBonusFilter('all')">
                    <mat-icon>star</mat-icon>
                    Tous
                  </button>
                  <button
                    class="custom-chip bonus-chip pdf"
                    [class.active]="selectedBonusFilter() === 'PDF'"
                    (click)="selectBonusFilter('PDF')">
                    PDF
                  </button>
                  <button
                    class="custom-chip bonus-chip pdc"
                    [class.active]="selectedBonusFilter() === 'PDC'"
                    (click)="selectBonusFilter('PDC')">
                    PDC
                  </button>
                  <button
                    class="custom-chip bonus-chip arm"
                    [class.active]="selectedBonusFilter() === 'ARM'"
                    (click)="selectBonusFilter('ARM')">
                    ARM
                  </button>
                  <button
                    class="custom-chip bonus-chip esq"
                    [class.active]="selectedBonusFilter() === 'ESQ'"
                    (click)="selectBonusFilter('ESQ')">
                    ESQ
                  </button>
                </div>
              </div>

              @if (hasAdvancedFilters()) {
                <div class="filter-actions">
                  <button mat-button class="reset-filters-btn" (click)="clearAdvancedFilters()">
                    <mat-icon>filter_alt_off</mat-icon>
                    Réinitialiser les filtres
                  </button>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Compteur et message -->
        <div class="results-header">
          <span class="results-count">{{ filteredEquipments().length }} équipement(s) trouvé(s)</span>
          @if (hasActiveFilters()) {
            <span class="filters-active">
              <mat-icon>filter_list</mat-icon>
              Filtres actifs
            </span>
          }
        </div>

        @if (filteredEquipments().length === 0) {
          <div class="no-results">
            <mat-icon>inventory_2</mat-icon>
            <h3>Aucun équipement trouvé</h3>
            <p>Essayez de modifier vos critères de recherche</p>
          </div>
        }

        <!-- Liste des équipements -->
        <div class="equipment-grid">
          @for (equipment of filteredEquipments(); track equipment.name) {
            <mat-card class="equipment-card hover-lift">
              <mat-card-content>
                <div class="equipment-header">
                  <h3>{{ equipment.name }}</h3>
                  <mat-chip color="warn" highlighted>{{ equipment.cost }} ₡</mat-chip>
                </div>
                <span class="category">{{ equipment.category }}</span>

                <!-- Bonus -->
                <div class="bonus-chips">
                  @if (equipment.pdfBonus > 0) {
                    <mat-chip class="bonus pdf">+{{ equipment.pdfBonus }} PDF</mat-chip>
                  }
                  @if (equipment.pdcBonus > 0) {
                    <mat-chip class="bonus pdc">+{{ equipment.pdcBonus }} PDC</mat-chip>
                  }
                  @if (equipment.armBonus > 0) {
                    <mat-chip class="bonus arm">+{{ equipment.armBonus }} ARM</mat-chip>
                  }
                  @if (equipment.evasionBonus > 0) {
                    <mat-chip class="bonus esq">+{{ equipment.evasionBonus }} ESQ</mat-chip>
                  }
                </div>

                <!-- Classes compatibles -->
                <div class="compatible-classes">
                  <span class="label">Compatible avec:</span>
                  <div class="class-chips">
                    @if (equipment.compatibleClass && equipment.compatibleClass.length > 0) {
                      @for (unitClass of equipment.compatibleClass; track unitClass.code) {
                        <mat-chip>{{ unitClass.name }}</mat-chip>
                      }
                    } @else {
                      <span class="none">Aucune</span>
                    }
                  </div>
                </div>

                <!-- Quantité possédée (toujours présent pour garder l'alignement) -->
                <p class="owned">
                  @if (getOwnedQuantity(equipment.name) > 0) {
                    Vous en possédez: <strong>{{ getOwnedQuantity(equipment.name) }}</strong>
                  }
                </p>

                <!-- Contrôles d'ajout au panier -->
                <div class="card-actions">
                  @if (getCartQuantity(equipment.name) === 0) {
                    <button mat-raised-button color="primary" class="add-btn" (click)="addToCart(equipment)">
                      <mat-icon>add_shopping_cart</mat-icon>
                      Ajouter au panier
                    </button>
                  } @else {
                    <div class="cart-controls">
                      <button mat-mini-fab color="warn" (click)="removeFromCart(equipment.name)">
                        <mat-icon>delete</mat-icon>
                      </button>
                      <div class="quantity-stepper">
                        <button mat-icon-button color="primary" (click)="decrementCartQuantity(equipment.name)">
                          <mat-icon>remove</mat-icon>
                        </button>
                        <span class="qty-value">{{ getCartQuantity(equipment.name) }}</span>
                        <button mat-icon-button color="primary" (click)="addToCart(equipment)">
                          <mat-icon>add</mat-icon>
                        </button>
                      </div>
                    </div>
                  }
                </div>
              </mat-card-content>
            </mat-card>
          }
        </div>
      </div>
    }
  </mat-sidenav-content>
</mat-sidenav-container>
