@if (loading$ | async) {
  <div class="loading-container">
    <mat-spinner diameter="60"></mat-spinner>
  </div>
} @else if (error$ | async; as error) {
  <div class="container">
    <div class="error-alert">
      <mat-icon>error</mat-icon>
      {{ error }}
    </div>
  </div>
} @else if (player$ | async; as player) {
  <div class="container fade-in">
    <!-- Header -->
    <div class="page-header">
      <div class="avatar">
        <mat-icon>person</mat-icon>
      </div>
      <div>
        <h1 class="title">{{ player.name }}</h1>
        <p class="subtitle">Commandant en chef</p>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-row">
      @for (stat of getMainStats(player); track stat.label) {
        <mat-card class="stat-card hover-lift">
          <mat-card-content>
            <div class="stat-content">
              <div>
                <p class="stat-label">{{ stat.label }}</p>
                <h3 class="stat-value">{{ stat.value }}</h3>
              </div>
              <div class="stat-icon" [style.background-color]="stat.color + '20'">
                <mat-icon [style.color]="stat.color">{{ stat.icon }}</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      }
    </div>

    <!-- Statistiques détaillées -->
    <mat-card class="card">
      <mat-card-content>
        <h2 class="section-title">Statistiques détaillées</h2>
        <p class="section-subtitle">Analyse complète de votre puissance</p>

        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">Puissance offensive</span>
            <span class="detail-value error">{{ player.stats.totalOffensivePower | number:'1.0-0' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Puissance défensive</span>
            <span class="detail-value success">{{ player.stats.totalDefensivePower | number:'1.0-0' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Puissance économique</span>
            <span class="detail-value warning">{{ player.stats.totalEconomyPower | number:'1.0-0' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Valeur des véhicules</span>
            <span class="detail-value">{{ player.stats.totalVehiclesValue | number:'1.0-0' }} ₡</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Valeur des équipements</span>
            <span class="detail-value">{{ player.stats.totalEquipmentValue | number:'1.0-0' }} ₡</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Armure totale</span>
            <span class="detail-value">{{ player.stats.totalArmor | number:'1.0-0' }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Équipements -->
    <mat-card class="card">
      <mat-card-content>
        <div class="section-header">
          <mat-icon color="primary">inventory_2</mat-icon>
          <h2>Équipements possédés</h2>
        </div>
        <p class="section-subtitle">Votre arsenal actuel</p>

        @if (player.equipments.length === 0) {
          <div class="empty-state">
            <mat-icon>inventory_2</mat-icon>
            <p>Aucun équipement pour le moment. Visitez la boutique !</p>
          </div>
        } @else {
          <div class="equipment-grid">
            @for (stack of player.equipments; track stack.equipment.name) {
              <div class="equipment-card">
                <div class="equipment-info">
                  <h4>{{ stack.equipment.name }}</h4>
                  <span class="category">{{ stack.equipment.category }}</span>
                  <div class="chips">
                    @if (stack.equipment.pdfBonus > 0) {
                      <mat-chip class="bonus-chip pdf">+{{ stack.equipment.pdfBonus }} PDF</mat-chip>
                    }
                    @if (stack.equipment.pdcBonus > 0) {
                      <mat-chip class="bonus-chip pdc">+{{ stack.equipment.pdcBonus }} PDC</mat-chip>
                    }
                    @if (stack.equipment.armBonus > 0) {
                      <mat-chip class="bonus-chip arm">+{{ stack.equipment.armBonus }} ARM</mat-chip>
                    }
                    @if (stack.equipment.evasionBonus > 0) {
                      <mat-chip class="bonus-chip esq">+{{ stack.equipment.evasionBonus }} ESQ</mat-chip>
                    }
                  </div>
                </div>
                <div class="quantity">×{{ stack.quantity }}</div>
              </div>
            }
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Territoires -->
    <mat-card class="card">
      <mat-card-content>
        <div class="section-header">
          <mat-icon color="primary">place</mat-icon>
          <h2>Territoires contrôlés</h2>
        </div>
        <p class="section-subtitle">Les secteurs sous votre commandement</p>

        @if (player.sectors.length === 0) {
          <div class="empty-state">
            <mat-icon>place</mat-icon>
            <p>Aucun territoire contrôlé. Partez à la conquête !</p>
          </div>
        } @else {
          <div class="territories-grid">
            @for (sector of player.sectors; track $index) {
              <div class="territory-card">
                <h4>{{ sector.name }}</h4>
                <span class="sector-number">Secteur #{{ sector.number ?? 'N/A' }}</span>
                <mat-divider></mat-divider>
                <div class="territory-stats">
                  <div class="stat-row">
                    <span>Revenus:</span>
                    <span class="warning">{{ sector.income ?? 0 }} ₡/tour</span>
                  </div>
                  @if (sector.army && sector.army.length > 0) {
                    <div class="stat-row">
                      <span>Unités:</span>
                      <span>{{ sector.army.length }}</span>
                    </div>
                  }
                  @if (sector.stats) {
                    <div class="stat-row">
                      <span>Défense:</span>
                      <span>+{{ sector.stats.defenseBonus }}</span>
                    </div>
                    <div class="stat-row">
                      <span>Production:</span>
                      <span>{{ sector.stats.resourceProduction }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
      </mat-card-content>
    </mat-card>
  </div>
}
