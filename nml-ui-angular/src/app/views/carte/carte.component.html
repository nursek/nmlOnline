<div class="min-h-screen bg-military-dark py-8 px-4">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-4xl font-military font-bold text-hud-blue mb-2">
          üó∫Ô∏è Carte des Secteurs
        </h1>
        <p class="text-gray-400">Vue strat√©gique de vos territoires contr√¥l√©s</p>
      </div>

      <!-- S√©lecteur de joueur -->
      @if (showPlayerSelector() && players().length > 0) {
        <div class="flex items-center gap-3">
          <span class="text-gray-400 text-sm uppercase tracking-wider">Joueur:</span>
          <select
            class="bg-military-darker border border-hud-blue/30 text-hud-blue px-4 py-2 rounded-md font-semibold focus:outline-none focus:border-hud-blue"
            (change)="onPlayerChange($event)">
            @for (p of players(); track p.name) {
              <option [value]="p.name" [selected]="p.name === player()?.name">{{ p.name }}</option>
            }
          </select>
        </div>
      }
    </div>

    <!-- Loading State -->
    @if (loading()) {
      <div class="flex items-center justify-center py-20">
        <div class="text-center">
          <div class="animate-spin rounded-full h-16 w-16 border-4 border-hud-blue border-t-transparent mx-auto mb-4"></div>
          <p class="text-gray-400">Chargement de la carte...</p>
        </div>
      </div>
    }

    <!-- Error State -->
    @if (error()) {
      <div class="card-military bg-warning-red/10 border-warning-red/30 p-6 text-center">
        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
        <p class="text-warning-red font-semibold">{{ error() }}</p>
        <button (click)="loadPlayerData()" class="btn-primary mt-4">
          üîÑ R√©essayer
        </button>
      </div>
    }

    <!-- Content -->
    @if (!loading() && !error() && player()) {
      <!-- R√©sum√© global -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="card-military p-4 text-center">
          <div class="text-3xl mb-2">üè∞</div>
          <div class="text-2xl font-military font-bold text-hud-blue">{{ sectors().length }}</div>
          <div class="text-sm text-gray-400 uppercase tracking-wider">Secteurs</div>
        </div>
        <div class="card-military p-4 text-center">
          <div class="text-3xl mb-2">‚öîÔ∏è</div>
          <div class="text-2xl font-military font-bold text-hud-cyan">{{ getTotalUnits() }}</div>
          <div class="text-sm text-gray-400 uppercase tracking-wider">Unit√©s</div>
        </div>
        <div class="card-military p-4 text-center">
          <div class="text-3xl mb-2">üí∞</div>
          <div class="text-2xl font-military font-bold text-warning-yellow">{{ getTotalIncome() | number }}</div>
          <div class="text-sm text-gray-400 uppercase tracking-wider">Revenus/Tour</div>
        </div>
        <div class="card-military p-4 text-center">
          <div class="text-3xl mb-2">üíµ</div>
          <div class="text-2xl font-military font-bold text-tactical-green">{{ player()!.stats?.money | number }}</div>
          <div class="text-sm text-gray-400 uppercase tracking-wider">Tr√©sorerie</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Map Container -->
        <div class="lg:col-span-2">
          <div class="card-military p-4 relative">
            <!-- Zoom Controls -->
            <div class="absolute top-6 right-6 z-10 flex flex-col gap-2">
              <button
                (click)="zoomIn()"
                class="w-10 h-10 bg-military-base hover:bg-military-lighter border border-hud-blue/30 rounded-md flex items-center justify-center text-hud-blue font-bold transition-all"
                title="Zoom avant"
              >
                +
              </button>
              <button
                (click)="zoomOut()"
                class="w-10 h-10 bg-military-base hover:bg-military-lighter border border-hud-blue/30 rounded-md flex items-center justify-center text-hud-blue font-bold transition-all"
                title="Zoom arri√®re"
              >
                ‚àí
              </button>
              <button
                (click)="resetView()"
                class="w-10 h-10 bg-military-base hover:bg-military-lighter border border-hud-blue/30 rounded-md flex items-center justify-center text-hud-blue text-xs transition-all"
                title="R√©initialiser"
              >
                ‚Ü∫
              </button>
            </div>

            <!-- SVG Map -->
            <div class="bg-military-darker rounded-lg overflow-hidden border border-hud-blue/20">
              <svg
                viewBox="0 0 750 800"
                class="w-full h-auto transition-transform duration-300"
                [style.transform]="'scale(' + zoom() + ')'"
              >
                <!-- Background Grid -->
                <defs>
                  <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                    <path
                      d="M 40 0 L 0 0 0 40"
                      fill="none"
                      stroke="rgba(0, 180, 216, 0.1)"
                      stroke-width="1"
                    />
                  </pattern>
                  <!-- Glow effect for selected -->
                  <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                    <feMerge>
                      <feMergeNode in="coloredBlur"/>
                      <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                  </filter>
                </defs>
                <rect width="750" height="800" fill="url(#grid)" />

                <!-- Secteurs -->
                @for (visual of sectorVisuals(); track visual.sector.number) {
                  <g class="sector-group">
                    <!-- Sector Path -->
                    <path
                      [attr.d]="visual.path"
                      [attr.fill]="visual.color"
                      [attr.stroke]="hoveredSector()?.number === visual.sector.number || selectedSector()?.number === visual.sector.number ? '#00b4d8' : '#2a3033'"
                      [attr.stroke-width]="hoveredSector()?.number === visual.sector.number || selectedSector()?.number === visual.sector.number ? '3' : '2'"
                      [attr.filter]="selectedSector()?.number === visual.sector.number ? 'url(#glow)' : ''"
                      class="cursor-pointer transition-all opacity-80 hover:opacity-100"
                      (click)="selectSector(visual.sector)"
                      (mouseenter)="hoveredSector.set(visual.sector)"
                      (mouseleave)="hoveredSector.set(null)"
                    />

                    <!-- Sector Number Badge -->
                    <circle
                      [attr.cx]="visual.centerX"
                      [attr.cy]="visual.centerY - 40"
                      r="18"
                      fill="#1a1f24"
                      stroke="#00b4d8"
                      stroke-width="2"
                      class="pointer-events-none"
                    />
                    <text
                      [attr.x]="visual.centerX"
                      [attr.y]="visual.centerY - 35"
                      text-anchor="middle"
                      class="fill-hud-blue font-military font-bold text-sm pointer-events-none"
                    >
                      {{ visual.sector.number }}
                    </text>

                    <!-- Sector Name -->
                    <text
                      [attr.x]="visual.centerX"
                      [attr.y]="visual.centerY - 5"
                      text-anchor="middle"
                      class="fill-gray-200 font-military font-bold text-xs pointer-events-none"
                    >
                      {{ visual.sector.name }}
                    </text>

                    <!-- Army Info -->
                    <text
                      [attr.x]="visual.centerX"
                      [attr.y]="visual.centerY + 20"
                      text-anchor="middle"
                      class="fill-gray-400 font-tactical text-xs pointer-events-none"
                    >
                      ‚öîÔ∏è {{ getArmySize(visual.sector) }} unit√©s
                    </text>

                    <!-- Income -->
                    <text
                      [attr.x]="visual.centerX"
                      [attr.y]="visual.centerY + 40"
                      text-anchor="middle"
                      class="fill-warning-yellow font-tactical text-xs pointer-events-none"
                    >
                      üí∞ {{ visual.sector.income | number }}
                    </text>
                  </g>
                }

                <!-- Message si aucun secteur -->
                @if (sectors().length === 0) {
                  <text x="375" y="325" text-anchor="middle" class="fill-gray-500 font-military text-lg">
                    Aucun secteur contr√¥l√©
                  </text>
                }
              </svg>
            </div>

            <!-- Legend -->
            <div class="mt-4 flex flex-wrap gap-4 text-sm">
              <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded" style="background-color: #3d5a3c;"></div>
                <span class="text-gray-400">Bien d√©fendu (5+ unit√©s)</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded" style="background-color: #5a6a3c;"></div>
                <span class="text-gray-400">D√©fense moyenne (3-4)</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded" style="background-color: #6a5a3c;"></div>
                <span class="text-gray-400">D√©fense faible (1-2)</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded" style="background-color: #4a5568;"></div>
                <span class="text-gray-400">Secteur vide</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Sector Info Panel -->
        <div class="lg:col-span-1">
          @if (selectedSector()) {
            <div class="card-military">
              <!-- Sector Header -->
              <div class="mb-6">
                <div class="flex items-center gap-3 mb-2">
                  <div class="w-12 h-12 bg-hud-blue/20 rounded-lg flex items-center justify-center text-hud-blue font-military font-bold text-xl">
                    {{ selectedSector()!.number }}
                  </div>
                  <div>
                    <h2 class="text-xl font-military font-bold text-hud-blue">
                      {{ selectedSector()!.name }}
                    </h2>
                    <div class="text-sm text-gray-400">Secteur contr√¥l√©</div>
                  </div>
                </div>
              </div>

              <!-- Stats -->
              <div class="space-y-3">
                <!-- Income -->
                <div class="bg-military-darker p-4 rounded-md">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-400 text-sm uppercase tracking-wider">Revenus</span>
                    <span class="text-2xl">üí∞</span>
                  </div>
                  <div class="text-2xl font-military font-bold text-warning-yellow">
                    {{ selectedSector()!.income | number }} / tour
                  </div>
                </div>

                <!-- Army -->
                <div class="bg-military-darker p-4 rounded-md">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-400 text-sm uppercase tracking-wider">Arm√©e</span>
                    <span class="text-2xl">‚öîÔ∏è</span>
                  </div>
                  <div class="text-2xl font-military font-bold text-hud-blue">
                    {{ getArmySize(selectedSector()!) }} unit√©s
                  </div>
                </div>

                <!-- Offensive Power -->
                <div class="bg-military-darker p-4 rounded-md">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-400 text-sm uppercase tracking-wider">Puissance Offensive</span>
                    <span class="text-2xl">üó°Ô∏è</span>
                  </div>
                  <div class="text-2xl font-military font-bold text-warning-red">
                    {{ getTotalOffensivePower(selectedSector()!) }}
                  </div>
                  <div class="text-xs text-gray-500 mt-1">ATK + PDF + PDC</div>
                </div>

                <!-- Defensive Power -->
                <div class="bg-military-darker p-4 rounded-md">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-400 text-sm uppercase tracking-wider">Puissance D√©fensive</span>
                    <span class="text-2xl">üõ°Ô∏è</span>
                  </div>
                  <div class="text-2xl font-military font-bold text-tactical-green">
                    {{ getTotalDefensivePower(selectedSector()!) }}
                  </div>
                  <div class="text-xs text-gray-500 mt-1">DEF + Armure</div>
                </div>

                <!-- Defense Level -->
                <div class="bg-military-darker p-4 rounded-md">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-400 text-sm uppercase tracking-wider">Niveau de D√©fense</span>
                    <span class="text-2xl">üè∞</span>
                  </div>
                  <div class="text-xl font-military font-bold"
                       [class.text-tactical-green]="getDefenseLevel(selectedSector()!) === 'Excellente' || getDefenseLevel(selectedSector()!) === 'Bonne'"
                       [class.text-warning-yellow]="getDefenseLevel(selectedSector()!) === 'Moyenne'"
                       [class.text-warning-red]="getDefenseLevel(selectedSector()!) === 'Faible' || getDefenseLevel(selectedSector()!) === 'Aucune'">
                    {{ getDefenseLevel(selectedSector()!) }}
                  </div>
                </div>
              </div>

              <!-- Detailed Stats Grid -->
              @if (selectedSector()!.stats) {
                <div class="mt-4">
                  <h4 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3">D√©tails des statistiques</h4>
                  <div class="grid grid-cols-5 gap-2 text-center">
                    <div class="bg-military-darker p-3 rounded-md">
                      <div class="text-lg font-bold text-warning-red">{{ selectedSector()!.stats.totalAtk | number:'1.0-0' }}</div>
                      <div class="text-xs text-gray-500 uppercase">ATK</div>
                    </div>
                    <div class="bg-military-darker p-3 rounded-md">
                      <div class="text-lg font-bold text-warning-orange">{{ selectedSector()!.stats.totalPdf | number:'1.0-0' }}</div>
                      <div class="text-xs text-gray-500 uppercase">PDF</div>
                    </div>
                    <div class="bg-military-darker p-3 rounded-md">
                      <div class="text-lg font-bold text-warning-yellow">{{ selectedSector()!.stats.totalPdc | number:'1.0-0' }}</div>
                      <div class="text-xs text-gray-500 uppercase">PDC</div>
                    </div>
                    <div class="bg-military-darker p-3 rounded-md">
                      <div class="text-lg font-bold text-tactical-green">{{ selectedSector()!.stats.totalDef | number:'1.0-0' }}</div>
                      <div class="text-xs text-gray-500 uppercase">DEF</div>
                    </div>
                    <div class="bg-military-darker p-3 rounded-md">
                      <div class="text-lg font-bold text-hud-cyan">{{ selectedSector()!.stats.totalArmor | number:'1.0-0' }}</div>
                      <div class="text-xs text-gray-500 uppercase">ARM</div>
                    </div>
                  </div>
                </div>
              }

              <!-- Army List -->
              @if (selectedSector()!.army && selectedSector()!.army.length > 0) {
                <div class="mt-6">
                  <h3 class="text-lg font-military font-bold text-hud-blue mb-3">Unit√©s pr√©sentes</h3>
                  <div class="space-y-3 max-h-80 overflow-y-auto pr-2">
                    @for (unit of selectedSector()!.army; track unit.id) {
                      <div class="bg-military-darker p-4 rounded-md border border-military-lighter hover:border-hud-blue/30 transition-all">
                        <!-- Header -->
                        <div class="flex items-center gap-3 mb-3">
                          <span class="text-3xl">{{ getUnitTypeIcon(unit) }}</span>
                          <div class="flex-1 min-w-0">
                            <div class="font-semibold text-gray-200 truncate">{{ unit.name || 'Unit√© #' + unit.id }}</div>
                            <div class="flex items-center gap-2">
                              <span class="text-xs px-2 py-0.5 bg-hud-blue/20 text-hud-blue rounded">{{ unit.type?.name || 'Type inconnu' }}</span>
                              @if (unit.isInjured) {
                                <span class="text-xs px-2 py-0.5 bg-warning-red/20 text-warning-red rounded">‚ö†Ô∏è Bless√©</span>
                              }
                            </div>
                          </div>
                          <div class="text-right">
                            <div class="text-sm font-bold text-warning-yellow">‚≠ê {{ unit.experience }}</div>
                          </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-3 gap-2 text-center text-xs">
                          <div class="bg-military-base p-2 rounded">
                            <div class="text-warning-red font-bold">{{ unit.attack || 0 }}</div>
                            <div class="text-gray-500">ATK</div>
                          </div>
                          <div class="bg-military-base p-2 rounded">
                            <div class="text-tactical-green font-bold">{{ unit.defense || 0 }}</div>
                            <div class="text-gray-500">DEF</div>
                          </div>
                          <div class="bg-military-base p-2 rounded">
                            <div class="text-hud-cyan font-bold">{{ unit.armor || 0 }}</div>
                            <div class="text-gray-500">ARM</div>
                          </div>
                        </div>

                        <!-- Classes -->
                        @if (unit.classes && unit.classes.length > 0) {
                          <div class="mt-2 flex flex-wrap gap-1">
                            @for (cls of unit.classes; track cls.name) {
                              <span class="text-xs px-2 py-0.5 bg-warning-orange/20 text-warning-orange rounded">{{ cls.name }}</span>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Actions -->
              <div class="mt-6 space-y-3">
                <button class="w-full btn-primary" disabled>
                  üìä G√©rer le secteur
                </button>
                <button class="w-full btn-secondary" disabled>
                  ‚ö° D√©ployer des troupes
                </button>
              </div>
            </div>
          } @else {
            <div class="card-military flex flex-col items-center justify-center py-12 text-center">
              <div class="text-6xl mb-4">üó∫Ô∏è</div>
              <h3 class="text-xl font-military font-bold text-gray-400 mb-2">
                S√©lectionnez un secteur
              </h3>
              <p class="text-gray-500 text-sm">
                Cliquez sur un secteur de la carte pour voir ses d√©tails
              </p>
            </div>
          }

          <!-- Sector List -->
          <div class="card-military mt-6">
            <h3 class="text-lg font-military font-bold text-hud-blue mb-4">
              Vos secteurs
            </h3>
            @if (sectors().length > 0) {
              <div class="space-y-2">
                @for (sector of sectors(); track sector.number) {
                  <button
                    (click)="selectSector(sector)"
                    [class.bg-military-lighter]="selectedSector()?.number === sector.number"
                    [class.border-hud-blue]="selectedSector()?.number === sector.number"
                    class="w-full text-left p-3 rounded-md border border-military-lighter hover:border-hud-blue/50 transition-all"
                  >
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-hud-blue/20 rounded flex items-center justify-center text-hud-blue font-bold text-sm">
                          {{ sector.number }}
                        </div>
                        <div>
                          <div class="font-semibold text-gray-200">{{ sector.name }}</div>
                          <div class="text-xs text-gray-500">üí∞ {{ sector.income | number }}</div>
                        </div>
                      </div>
                      <div class="text-sm text-gray-400">
                        ‚öîÔ∏è {{ getArmySize(sector) }}
                      </div>
                    </div>
                  </button>
                }
              </div>
            } @else {
              <p class="text-gray-500 text-center py-4">Aucun secteur contr√¥l√©</p>
            }
          </div>
        </div>
      </div>
    }
  </div>
</div>
